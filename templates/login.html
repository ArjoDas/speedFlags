{% extends "layout.html" %}


{% block title %}{% endblock %} <!-- no title for index -->

{% block body%}
<script>
    // High Scope variables for cross function referrence
    let current_country = ''
    let game_started = false
    let game_ended = false

    // Obtain random a2
    async function getRandomA2() {
        const response = await fetch('/random_country', {
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            })
        })
        const data = await response.json();
        return data
    }

    // Gets the svg code given a cca2
    async function get_svg(a2) {
        const response = await fetch('/get_svg', {
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                a2code: a2
            })
        })
        const data = await response.json();
        return data
    }

    // Function to set SVG dimensions
    function setSvgDimensions(svgElement, container) {
        // Remove any hardcoded width and height
        svgElement.removeAttribute('width');
        svgElement.removeAttribute('height');

        // Set a fixed height (adjust this value as needed)
        const fixedHeight = 300; // in pixels

        // Get the viewBox
        let viewBox = svgElement.getAttribute('viewBox');
        if (!viewBox) {
            // If viewBox doesn't exist, create one based on the SVG's current dimensions
            const width = svgElement.width.baseVal.value;
            const height = svgElement.height.baseVal.value;
            viewBox = `0 0 ${width} ${height}`;
            svgElement.setAttribute('viewBox', viewBox);
        }

        // Parse the viewBox values
        const [minX, minY, vbWidth, vbHeight] = viewBox.split(' ').map(Number);
        // Calculate the aspect ratio
        const aspectRatio = vbWidth / vbHeight;
        // Calculate the width based on the fixed height and aspect ratio
        const width = fixedHeight * aspectRatio;

        // Set the SVG dimensions
        svgElement.style.width = `${width}px`;
        svgElement.style.height = `${fixedHeight}px`;
        // Ensure the viewBox covers the entire SVG area
        svgElement.setAttribute('viewBox', `${minX} ${minY} ${vbWidth} ${vbHeight}`);

        // Style the container
        container.style.width = '100%';  // Changed from fixed width to 100%
        container.style.height = `${fixedHeight}px`;
        container.style.overflow = 'hidden';
        container.style.display = 'flex';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';

        // Style the SVG
        container.style.width = '100%';     // Ensure SVG doesn't overflow container
        container.style.height = '300px';   // Set a fixed height
        container.style.display = 'flex';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';

    }

    // Uses the above functions to load the flag
    async function loadFlagSvg() {
        try {
            // fetch api data
            const a2_data = await getRandomA2();
            const svg_data = await get_svg(a2_data.a2);

            // assign current flag for cross reference 
            current_country = { ...svg_data };
            delete current_country.svg_code;

            // select flag parent
            const svgContainer = document.getElementById('flag-svg');
            const flagInput = document.getElementById('flag-input');
            if (svgContainer) {
                // basic innerHTML manipulation
                svgContainer.innerHTML = svg_data.svg_code

                if (!game_started) {
                    flagInput.placeholder = svg_data.common;
                } else {
                    flagInput.placeholder = "Country Name";
                }
                // console.log(svg_data.common)

                // styling the svg
                const svgElement = svgContainer.querySelector('svg');
                if (svgElement) {
                    // Configure viewBox if it doesn't exist
                    if (!svgElement.getAttribute('viewBox')) {
                        const width = svgElement.getAttribute('width') || svgElement.getBoundingClientRect().width;
                        const height = svgElement.getAttribute('height') || svgElement.getBoundingClientRect().height;
                        svgElement.setAttribute('viewBox', `0 0 ${width} ${height}`);
                    }
                    // Apply the new dimensioning function
                    setSvgDimensions(svgElement, svgContainer);
                }
            }
        } catch (error) {
            console.error('Error loading flag:', error);
        }
    }
    
    // Autocompletes country name input
    async function autoComplete() {
        var flagInput = document.getElementById("flag-input");
        var countryOptions = document.getElementById('country-options');

        flagInput.addEventListener('input', async function() {
            let response = await fetch('/autocomplete_country?q=' + flagInput.value);
            let country_data = await response.json();

            // Sort the country data (shorter on top)
            let sortedCountries = Object.values(country_data).sort((a, b) => {
                const aCommon = a.common.toLowerCase();
                const bCommon = b.common.toLowerCase();
                
                // Check if one is a substring of the other
                if (aCommon.includes(bCommon)) return 1;
                if (bCommon.includes(aCommon)) return -1;
                
                // If neither is a substring of the other, sort alphabetically
                return aCommon.localeCompare(bCommon);
            });
            // console.log(sortedCountries)
            let html = ''; // going to be countryOptions.innerHTML
            let i = 0;
            for (let country of sortedCountries) {
                let option = country.common.replace(/</g, '&lt;').replace(/&/g, '&amp;');
                if (i === 0){
                    html += '<li id="best-option" class="first-option list-group-item list-group-item-secondary border-primary border-2">' + option + '</li>';
                }
                else if(i === sortedCountries.lenth - 1){
                    html += '<li class="last-option list-group-item list-group-item-secondary">' + option + '</li>';
                }
                else {
                    html += '<li class="list-group-item list-group-item-secondary">' + option + '</li>';
                }
                i++;
            }
            countryOptions.innerHTML = html;
            });
    }

    // Invalid feedback non-alphabet characters (Something like instagram)
    function detect_wrong_chars() {
        const flagInput = document.getElementById("flag-input");
        let removeInvalidClassTimeout;

        flagInput.addEventListener('input', function() {
            const inputValue = this.value;
            const lastChar = inputValue.charAt(inputValue.length - 1);
            
            if (!/^[a-zA-Z\s-]$/.test(lastChar) && lastChar !== '') {
                // Remove the invalid character
                this.value = inputValue.slice(0, -1);
                
                // Add the is-invalid class
                flagInput.classList.add("is-invalid");
                
                // Clear any existing timeout
                clearTimeout(removeInvalidClassTimeout);
                
                // Set a new timeout to remove the class
                removeInvalidClassTimeout = setTimeout(() => {
                    flagInput.classList.remove("is-invalid");
                }, 200);
            } else {
                // If the input is valid, remove the invalid class immediately
                flagInput.classList.remove("is-invalid");
                clearTimeout(removeInvalidClassTimeout);
            }
        });
    }

    // completes the 'autocorrect functionality' by changing the value to the deisred value
    function select_best(){
        const flag_input = document.getElementById('flag-input')
        // the legendary event listener
        flag_input.addEventListener('keydown', function(event) {
            console.log(event.key);
            if (event.key === 'Enter') {
                event.preventDefault();
                const best_option = document.getElementById('best-option');
                if(best_option){
                    this.value = best_option.textContent
                    // ensures other code looking for change in input are notified
                    this.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }            
        })
    }

    // allows user to select options other than just the first with arrow keys
    function move_selected_option(){
        const flag_input = document.getElementById('flag-input')
        flag_input.addEventListener('keydown', function(event) {
            // console.log(event.key);
            let current_option = document.getElementById('best-option')
            let first_option = document.querySelector('.first-option');
            let last_option = document.querySelector('.last-option')

            if (event.key === 'ArrowDown' || event.key === 'ArrowRight') {
                event.preventDefault();
                // select below
                if(current_option && current_option != last_option){
                    let next_option = current_option.nextElementSibling;
                    if(next_option){
                        current_option.removeAttribute('id');
                        next_option.id = 'best-option';
                        next_option.classList.add(...['border-primary', 'border-2'])
                        current_option.classList.remove(...['border-primary', 'border-2'])
                    }
                }
            }
            else if (event.key === 'ArrowUp' || event.key === 'ArrowLeft') {
                event.preventDefault()
                // select above
                if(current_option && current_option != first_option){
                    let prev_option = current_option.previousElementSibling;
                    if(prev_option){
                        current_option.removeAttribute('id');
                        prev_option.id = 'best-option';
                        prev_option.classList.add(...['border-primary', 'border-2'])
                        current_option.classList.remove(...['border-primary', 'border-2'])
                    }
                }
            }
        })            
    }


    // Basic DOMContentLoaded stuff
    document.addEventListener('DOMContentLoaded', () => {
        loadFlagSvg();
        autoComplete();
        detect_wrong_chars();
        select_best();
        move_selected_option();
        initialise_game();
    });
</script>

<style>
    .flag-container {
        min-height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #flag-svg {
        width: 100%;
        height: 100%;
    }
    #flag-input{
        text-align: center; 
        caret-color: transparent;
    }

    input, .input-group, .input-group-lg, .list-group, .alert, .progress, .btn {
        border-radius: 0px !important;
    }

    .progress{
        height: 3px;
    }


    /* $form-feedback-icon-invalid: None; */
    
</style>

<div class="container-lg py-1">
    <div id="info-board" class="alert alert-primary mb-2 text-center" role="alert" style="min-height: 165.2px !important;">
        <div class="justify-content-center my-0">
            <div>
                <div id="info-header" class="display-4 mb-0 fw-semibold fst-italic font-monospace">30.0</div>
                <div class="row justify-content-center align-items-center">
                    <span class="col-auto fs-5 mb-0">Score: <span id="score" class="font-monospace display-5">0</span></span>
                    <span class="col-auto fs-5 mb-0">Tries: <span id="attempts" class="font-monospace display-5">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <div class="progress mb-2" role="progressbar">
        <div class="progress-bar bg-primary" style="width: 100%"></div>
    </div>

    <div class="alert alert-dark mb-4 text-success-emphasis" role="alert" style="min-height: 651px; min-width: 1296;">
        <div class="text-center mb-2">
            <p class="display-4 mb-0"><span class="fw-semibold">Great effort.</span> Here's how you did </p>
        </div>
        <div id="score-review" class="row justify-content-center">
            <!-- insert flags and times here -->
        </div>
        <div class="text-center mb-0">
            <p class="fs-6 fw-light mb-0">To improve your score, try <a href="/" class="btn btn-outline-primary btn-sm">Practicing</a> We take note of the countries you don't remember and ask you those more</p>
            <a href="/" class="btn btn-outline-primary btn-sm">Try Again</a>  
        </div>
    </div>

<script>

</script>

{% endblock %}